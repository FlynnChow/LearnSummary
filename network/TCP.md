## TCP协议

### TPC 握手

#### 为什么要三次握手过程

**三次握手的目的是建立可靠的通信信道**

1. 客户端向服务器发送信息，服务器可以确认客户端的发信能力和服务器的接信能力

2. 服务器向服务器发送信息，客户端可以确认服务器的发信能力和接信能力，以及客户端的发信能力与接信能力

3. 客户端向服务器发送信息，服务器可以确认服务器的发信能力和客户端的接信能力

**所以三次握手才能确认双发收发功能都正常**

#### 为什么需要四次挥手

tcp链接是全双工的

* 主机1发送完数据告诉主机2位要关闭连接了，如果主机2还没有发送完毕数据可以继续发送，主机2只需回复知道主机1关闭连接了，还可以继续发数据，主机1会继续等待主机2的关闭链接标识(FIN)。

* 主机2发完数据后就可以发送关闭链接标识(FIN)关闭连接了

* 主机1只需回复个确认就结束了

#### TCP 握手和挥手

![](/Users/bytedance/Library/Mobile Documents/com~apple~CloudDocs/学习总结/LearnSummary/network/images/tcp_hand.jpg)

**3次握手**

1. 客户端发送：设置SYN为1，并且置seq为随机数x，此时客户端为SYN_SEND状态

2. 服务器发送：设置SYN为1，并且置seq为随机数y，设置ASK为1，ask为x+1，此时服务器为SYN_RECV状态

3. 客户端发送：设置ask为y+1。次数客户端和服务器都为ESTABLISHED状态

**4次挥手**

1. 主机1发送：设置FIN为1，设置seq，设置ask，主机1进入FIN_WAIT_1

2. 主机2发送：设置ask为sqe+1,主机2进入CLOSE_WAIT状态，主机1进入FIN_WAIT_2状态

3. 主机2发送：设置FIN为1，设置seq，主机2进入LAST_WAIT状态之后关闭连接

4. 主机1发送：设置ask为seq+1，主机1进入TIME_WAIT状态，过一段时间后没有响应主机1关闭连接

### 拥塞控制

#### 慢启动算法

TCP连接刚建立，慢慢地提速，试探网络的承受能力，以免扰乱了网络通道的秩序。

 1) 先初始化拥塞窗口大小(cwnd)为1，表明最大报文长度(MSS)的大小为1。

 2) 每当收到一个ACK，拥塞窗口大小(cwnd)加一，呈线性上升。

 3) 每当过了一个往返延迟时间，拥塞窗口大小(cwnd)大小翻倍。

 4) 有一个慢启动阈值，拥塞窗口大小(cwnd) >= 慢启动阈值(ssthresh)时，进入“拥塞避免算法”

如果发生了超时，发送方将拥塞窗口(cwnd)设置为1，慢启动阈值设置为原来一半，重新开始慢启动过程。

#### 拥塞避免算法

拥塞避免算法可以避免窗口增长过快导致窗口拥塞。

每当过了一个往返延迟时间，拥塞窗口(cwnd)大小加一，呈线性上升。

#### 快速重传算法

如果连续收到3个或3个以上的重复ACK，那么就重传丢失的数据报文段，然后慢启动阈值设置为原来的一半，拥塞窗口等于慢启动阀值，然后进入拥塞避免算法。

#### 快速恢复算法

如果连续收到3个或3个以上的重复ACK，那么拥塞窗口大小变为原来一半，然后加三，再重传丢失的数据报文段。

如果再次收到重复的ACK,拥塞窗口大小加一

如果收到新的ACK，拥塞窗口变为原来慢启动阀值的大小，重新进入拥塞避免算法

### 流量控制

#### 滑动窗口

1. 每个TCP连接的两端都维护一组窗口：发送窗口和接收窗口，窗口大小取决于系统，硬件或网络的限制。

2. 发送窗口收到接收端对于本段窗口内字节的ACK确认才会移动发送窗口的左边界。

3. 接收窗口只有在前面所有的段都确认的情况下才会移动左边界，当前面还有字节未接收但收到后面字节的情况下窗口是不会移动的，并不对后续字节确认, 确保数据的重传。

### 保证可靠传输

#### 校验和

TCP将保持它首部和数据的检验和。如果收到段的检验和有差错，TCP将丢弃这个报文段。

#### 超时重传

当TCP发出一个段后，它启动一个定时器。如果不能及时收到一个确认，将重发这个报文段。

#### 停止等待协议

每发完一个分组就停止发送，等待对方确认。在收到确认后再发下一个分组。